# 打卡时间和次数限制功能

## 📋 功能概述

实现了简洁的打卡时间和次数限制功能，管理员可以通过考勤规则配置：
- 上班打卡最早时间限制
- 每天打卡次数限制
- 迟到/早退判断由阈值控制

## 🎯 功能特性

### 1. 上班打卡时间限制
- **可提前打卡时间**：限制用户最早可以在上班时间前多久打卡
- **示例**：上班时间9:00，可提前30分钟
  - 最早打卡时间：8:30
  - 8:29之前打卡：提示"打卡时间过早，最早可在 08:30 打卡"
  - 8:30之后打卡：允许（是否迟到由迟到阈值判断）

### 2. 迟到/早退判断
- **迟到判断**：由规则的"迟到阈值"控制
  - 例如：上班9:00，迟到阈值15分钟
  - 9:00-9:15：正常
  - 9:15之后：迟到
- **早退判断**：由规则的"早退阈值"控制
  - 例如：下班18:00，早退阈值15分钟
  - 17:45之前：早退
  - 17:45之后：正常

### 3. 每天打卡次数限制
- **启用后**：每天只能打卡一次（上班或下班）
- **禁用后**：可以多次打卡
- **检测逻辑**：查询当天是否已有打卡记录

### 4. 开放模式优先
- 如果规则启用了"开放模式"，所有时间和次数限制都不生效
- 任何时间都可以打卡，不限制次数

## 🗄️ 数据库字段

### attendance_rule 表新增字段

| 字段名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| checkin_before_minutes | INTEGER | 30 | 上班打卡可提前多少分钟 |
| enable_once_per_day | BOOLEAN | TRUE | 是否限制每天只能打卡一次 |

## 💻 使用方法

### 管理员配置

1. 登录管理员账号
2. 进入"考勤规则"页面
3. 创建或编辑规则
4. 在"⏰ 打卡时间限制"区域配置：
   - ✅ 每天只能打卡一次
   - ✅ 启用打卡时间限制
   - 上班可提前打卡：30 分钟
4. 保存规则

### 用户打卡

1. 打开打卡页面
2. 开启摄像头
3. 系统实时显示：
   - 识别到的用户
   - 应用的规则
   - 预计打卡状态
4. 点击"立即打卡"
5. 如果不在允许的时间窗口内，显示错误提示

## 📊 错误提示示例

### 1. 打卡时间过早
```
❌ 打卡失败
打卡时间过早，最早可在 08:30 打卡
```

### 2. 打卡时间过晚
```
❌ 打卡失败
打卡时间过晚，最晚可在 11:00 打卡
```

### 3. 今天已打过卡
```
❌ 打卡失败
今天已经打过卡了（09:05:30），每天只能打卡一次
```

## 🔧 技术实现

### 后端检查逻辑

```python
# services/attendance_rule_service.py
def check_checkin_window(rule, user_id, check_time):
    # 1. 检查开放模式
    if rule.is_open_mode:
        return {'allowed': True}
    
    # 2. 检查每天打卡次数
    if rule.enable_once_per_day:
        if has_checked_in_today(user_id):
            return {'allowed': False, 'message': '今天已经打过卡'}
    
    # 3. 检查时间窗口
    if rule.enable_checkin_window:
        if not in_time_window(check_time, rule):
            return {'allowed': False, 'message': '不在打卡时间范围内'}
    
    return {'allowed': True}
```

### 前端配置界面

```tsx
<Form.Item label="启用上班打卡时间窗口" name="enable_checkin_window">
  <Switch />
</Form.Item>

<Form.Item label="可提前（分钟）" name="checkin_before_minutes">
  <InputNumber min={0} max={180} />
</Form.Item>

<Form.Item label="可延后（分钟）" name="checkin_after_minutes">
  <InputNumber min={0} max={300} />
</Form.Item>
```

## 🎯 使用场景

### 场景1：严格考勤
```
上班时间：09:00
可提前：0分钟
可延后：0分钟
每天一次：是

→ 只能在9:00准时打卡
```

### 场景2：弹性工作制
```
上班时间：09:00
可提前：60分钟
可延后：180分钟
每天一次：是

→ 可在8:00-12:00之间打卡
```

### 场景3：开放打卡
```
开放模式：是

→ 任何时间都可以打卡，不限次数
```

### 场景4：允许补打卡
```
每天一次：否

→ 可以多次打卡（忘记打卡可以补打）
```

## ⚠️ 注意事项

1. **开放模式优先级最高**
   - 启用开放模式后，所有时间和次数限制都失效

2. **时间窗口合理性**
   - 建议可延后时间 > 迟到阈值
   - 避免设置过短的时间窗口

3. **每天一次限制**
   - 启用后无法当天补打卡
   - 如需补打卡，管理员需要手动添加记录

4. **数据库迁移**
   - 必须先执行 SQL 脚本添加新字段
   - 否则会报错"字段不存在"

## 📝 配置建议

### 标准工作日
```
上班时间：09:00
可提前：30分钟
可延后：120分钟
迟到阈值：15分钟
每天一次：是
```

### 弹性工作制
```
上班时间：10:00
可提前：60分钟
可延后：180分钟
迟到阈值：30分钟
每天一次：否
```

### 严格模式
```
上班时间：09:00
可提前：15分钟
可延后：30分钟
迟到阈值：5分钟
每天一次：是
```

## 🚀 后续扩展

可以考虑添加：
- 下班打卡时间窗口的延后限制
- 不同打卡类型（上班/下班）分别限制
- 特殊日期的时间窗口调整
- 打卡次数的详细统计
