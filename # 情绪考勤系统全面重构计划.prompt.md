# 情绪考勤系统全面重构计划

## 核心原则

- **统一使用PyTorch**: 所有深度学习模型(YOLO、FaceNet、情绪识别CNN)均使用PyTorch实现,移除TensorFlow依赖
- **统一使用YOLO**: 仅使用YOLO进行人脸检测,移除MTCNN依赖
- **前后端分离**: frontend/ 和 backend/ 清晰分离
- **模块化设计**: 训练、推理、API、前端各自独立
- **现代化界面**: React + Antd 5 + TypeScript + Zustand

## 项目结构

```
emotion_attendance_v2/
├── backend/
│   ├── config/
│   │   ├── __init__.py
│   │   ├── settings.py              # 统一配置管理
│   │   └── .env.example             # 环境变量模板
│   │
│   ├── train/                       # 训练脚本模块
│   │   ├── __init__.py
│   │   ├── README.md                # 训练文档
│   │   │
│   │   ├── common/                  # 共享工具
│   │   │   ├── __init__.py
│   │   │   ├── yolo_detector.py     # YOLO检测器封装
│   │   │   └── data_utils.py        # 数据处理工具
│   │   │
│   │   ├── train_yolo/              # YOLO人脸检测训练
│   │   │   ├── __init__.py
│   │   │   ├── train.py             # 训练脚本
│   │   │   ├── test.py              # 测试脚本
│   │   │   ├── data.yaml            # 数据配置
│   │   │   └── data/                # 训练数据
│   │   │
│   │   ├── train_facenet/           # FaceNet人脸识别训练(PyTorch)
│   │   │   ├── __init__.py
│   │   │   ├── collect_faces.py     # 采集人脸(使用YOLO)
│   │   │   ├── train.py             # 训练SVM分类器
│   │   │   ├── test.py              # 测试脚本
│   │   │   └── dataset/             # 人脸数据集
│   │   │
│   │   ├── train_emotion_pytorch/   # PyTorch情绪识别训练
│   │   │   ├── __init__.py
│   │   │   ├── model.py             # CNN模型定义
│   │   │   ├── dataset.py           # 数据集加载
│   │   │   ├── train.py             # 训练脚本
│   │   │   ├── test.py              # 测试脚本
│   │   │   └── data/                # FER2013或自定义数据
│   │   │
│   │   └── train_emotion_sklearn/   # Sklearn情绪识别训练
│   │       ├── __init__.py
│   │       ├── utils.py             # MediaPipe特征提取
│   │       ├── data.py              # 数据准备
│   │       ├── train.py             # 训练SVM
│   │       ├── test.py              # 测试脚本
│   │       └── data/                # 情绪图像数据
│   │
│   ├── models/                      # 模型管理模块
│   │   ├── __init__.py
│   │   ├── model_manager.py         # 单例模型管理器
│   │   ├── yolo_face_detector.py    # YOLO人脸检测推理
│   │   ├── facenet_recognizer.py    # FaceNet人脸识别推理
│   │   └── emotion_recognizer.py    # 情绪识别推理
│   │
│   ├── services/                    # 业务逻辑层
│   │   ├── __init__.py
│   │   ├── face_service.py          # 人脸检测+识别服务
│   │   ├── emotion_service.py       # 情绪识别服务
│   │   ├── user_service.py          # 用户管理服务
│   │   └── attendance_service.py    # 考勤管理服务
│   │
│   ├── database/                    # 数据库模块
│   │   ├── __init__.py
│   │   ├── models.py                # SQLAlchemy ORM模型
│   │   ├── repositories.py          # 数据访问层
│   │   ├── init_db.py               # 数据库初始化
│   │   └── migrate_from_csv.py      # 旧数据迁移脚本
│   │
│   ├── api/                         # Flask API模块
│   │   ├── __init__.py
│   │   ├── app.py                   # Flask应用入口
│   │   ├── middleware.py            # 中间件(错误处理、日志等)
│   │   └── routes/                  # 路由模块
│   │       ├── __init__.py
│   │       ├── user.py              # 用户相关API
│   │       ├── attendance.py        # 考勤相关API
│   │       ├── statistics.py        # 统计分析API
│   │       ├── video.py             # 视频流API
│   │       └── system.py            # 系统状态API
│   │
│   ├── saved_models/                # 保存的模型文件
│   │   ├── yolov8n-face.pt
│   │   ├── facenet_embeddings.npz
│   │   ├── facenet_svm.pkl
│   │   ├── emotion_cnn.pth          # PyTorch情绪模型
│   │   └── emotion_svm.pkl
│   │
│   ├── data/                        # 运行时数据
│   │   ├── database.db              # SQLite数据库
│   │   └── user_faces/              # 用户人脸数据
│   │
│   ├── logs/                        # 日志目录
│   │
│   ├── requirements.txt             # Python依赖
│   ├── .env.example                 # 环境变量示例
│   └── README.md                    # 后端文档
│
└── frontend/                        # 前端模块
    ├── src/
    │   ├── components/              # 组件
    │   │   ├── Dashboard/           # 仪表盘
    │   │   ├── AttendanceCard/      # 打卡卡片
    │   │   ├── UserManagement/      # 用户管理
    │   │   ├── AttendanceHistory/   # 历史记录
    │   │   ├── StatisticsChart/     # 统计图表
    │   │   └── VideoStream/         # 视频流组件
    │   │
    │   ├── store/                   # Zustand状态管理
    │   │   ├── userStore.ts
    │   │   ├── attendanceStore.ts
    │   │   └── systemStore.ts
    │   │
    │   ├── api/                     # API封装
    │   │   └── client.ts
    │   │
    │   ├── types/                   # TypeScript类型定义
    │   │
    │   ├── App.tsx                  # 主应用
    │   └── main.tsx                 # 入口
    │
    ├── package.json
    ├── tsconfig.json
    ├── vite.config.ts
    └── README.md
```

## 实施步骤

### 第一阶段: 训练模块重构 (统一PyTorch)

#### 1.1 创建项目基础结构和配置
- [x] 创建目录结构
- [ ] 创建 `backend/config/settings.py` - 统一配置管理
- [ ] 创建 `backend/config/.env.example` - 环境变量模板
- [ ] 创建 `backend/requirements.txt` - 依赖清单(仅PyTorch)

#### 1.2 共享工具模块
- [ ] `backend/train/common/yolo_detector.py` - YOLO检测器封装类
- [ ] `backend/train/common/data_utils.py` - 数据处理工具

#### 1.3 YOLO人脸检测训练
- [ ] 复制并整理 `train_yolo/` 训练数据
- [ ] 创建 `train_yolo/train.py` - 训练脚本
- [ ] 创建 `train_yolo/test.py` - 测试脚本
- [ ] 创建 `train_yolo/data.yaml` - 数据配置

#### 1.4 FaceNet人脸识别训练 (改用PyTorch)
- [ ] 安装 `facenet-pytorch` 库
- [ ] 创建 `train_facenet/collect_faces.py` - 使用YOLO采集人脸
- [ ] 创建 `train_facenet/train.py` - 提取FaceNet特征并训练SVM
- [ ] 创建 `train_facenet/test.py` - 测试脚本

#### 1.5 PyTorch情绪识别训练 (替代TensorFlow)
- [ ] 创建 `train_emotion_pytorch/model.py` - 定义CNN模型
- [ ] 创建 `train_emotion_pytorch/dataset.py` - 数据集加载器
- [ ] 创建 `train_emotion_pytorch/train.py` - 训练脚本
- [ ] 创建 `train_emotion_pytorch/test.py` - 测试脚本

#### 1.6 Sklearn情绪识别训练 (保留)
- [ ] 复制并改进 `train_emotion_sklearn/` 脚本
- [ ] 使用YOLO预处理人脸(如需要)

### 第二阶段: 后端核心模块

#### 2.1 模型管理器 (单例模式)
- [ ] `backend/models/model_manager.py` - 单例,预加载所有模型
- [ ] `backend/models/yolo_face_detector.py` - YOLO推理封装
- [ ] `backend/models/facenet_recognizer.py` - FaceNet推理封装
- [ ] `backend/models/emotion_recognizer.py` - 情绪识别推理封装

#### 2.2 数据库设计
- [ ] `backend/database/models.py` - ORM模型定义
  - User: id, username, created_at, avatar_path
  - Attendance: id, user_id, timestamp, emotion, status, image_base64
  - SystemLog: id, event_type, message, timestamp
- [ ] `backend/database/repositories.py` - Repository模式封装CRUD
- [ ] `backend/database/init_db.py` - 初始化数据库
- [ ] `backend/database/migrate_from_csv.py` - 旧数据迁移

#### 2.3 业务服务层
- [ ] `backend/services/face_service.py`
  - detect_face(frame) -> face_region
  - recognize_face(face_region) -> user_id
  - register_user(username, face_images) -> success
- [ ] `backend/services/emotion_service.py`
  - recognize_emotion(face_region, model_type) -> emotion
- [ ] `backend/services/user_service.py`
  - create_user, get_users, delete_user, update_user
- [ ] `backend/services/attendance_service.py`
  - check_in(user_id, emotion, image) -> success
  - get_attendance_history(filters) -> records
  - get_statistics(date_range) -> stats

#### 2.4 Flask API
- [ ] `backend/api/app.py` - Flask应用初始化
- [ ] `backend/api/middleware.py` - 错误处理、日志、CORS
- [ ] `backend/api/routes/user.py`
  - POST /api/users/register - 注册用户
  - GET /api/users - 获取用户列表
  - DELETE /api/users/:id - 删除用户
- [ ] `backend/api/routes/attendance.py`
  - POST /api/attendance/check-in - 打卡
  - GET /api/attendance/history - 历史记录
  - GET /api/attendance/export - 导出CSV/Excel
- [ ] `backend/api/routes/statistics.py`
  - GET /api/statistics/daily - 每日统计
  - GET /api/statistics/emotion-distribution - 情绪分布
  - GET /api/statistics/user-trend/:id - 用户趋势
- [ ] `backend/api/routes/video.py`
  - GET /api/video/feed - 视频流
- [ ] `backend/api/routes/system.py`
  - GET /api/system/health - 健康检查
  - GET /api/system/model-status - 模型状态

### 第三阶段: 前端现代化

#### 3.1 基础设置
- [ ] 初始化 Vite + React + TypeScript 项目
- [ ] 安装依赖: antd, zustand, axios, echarts, dayjs
- [ ] 配置 Vite、TypeScript

#### 3.2 状态管理
- [ ] `frontend/src/store/userStore.ts` - 用户状态
- [ ] `frontend/src/store/attendanceStore.ts` - 考勤状态
- [ ] `frontend/src/store/systemStore.ts` - 系统状态

#### 3.3 API客户端
- [ ] `frontend/src/api/client.ts` - Axios封装
- [ ] 定义所有API接口方法

#### 3.4 组件开发
- [ ] `Dashboard.tsx` - 仪表盘总览
- [ ] `AttendanceCard.tsx` - 打卡功能卡片
- [ ] `VideoStream.tsx` - 实时视频流
- [ ] `UserManagement.tsx` - 用户管理表格
- [ ] `AttendanceHistory.tsx` - 历史记录(分页、筛选)
- [ ] `StatisticsChart.tsx` - ECharts统计图表
- [ ] `Settings.tsx` - 系统设置

#### 3.5 主应用
- [ ] `App.tsx` - 路由、布局
- [ ] 响应式设计
- [ ] 深色模式支持

## 技术栈

### 后端 (Python)
- **深度学习框架**: PyTorch (统一框架)
- **Web框架**: Flask + Flask-CORS
- **数据库**: SQLite + SQLAlchemy
- **人脸检测**: YOLOv8 (Ultralytics)
- **人脸识别**: FaceNet (facenet-pytorch)
- **情绪识别**: 
  - PyTorch CNN
  - Sklearn SVM + MediaPipe
  - (可选)DeepFace
- **其他**: NumPy, Pandas, OpenCV, Pillow

### 前端 (TypeScript)
- **框架**: React 18
- **构建工具**: Vite
- **UI库**: Ant Design 5
- **状态管理**: Zustand
- **图表**: ECharts
- **HTTP**: Axios
- **工具库**: dayjs, immer

## 关键改进点

### 1. 性能优化
- ✅ 模型单例预加载,消除重复加载瓶颈
- ✅ GPU内存管理优化
- ✅ 统一使用PyTorch,减少框架切换开销
- ✅ 数据库索引优化

### 2. 代码质量
- ✅ 模块化设计,职责清晰
- ✅ 配置统一管理,消除硬编码
- ✅ 完善的异常处理和日志
- ✅ 类型注解和文档

### 3. 功能丰富
- ✅ 用户管理(增删改查)
- ✅ 考勤历史查询、筛选、分页
- ✅ 统计分析(日报、情绪分布、趋势)
- ✅ 数据导出(CSV、Excel)
- ✅ 系统健康监控

### 4. 用户体验
- ✅ 现代化UI设计
- ✅ 响应式布局
- ✅ 加载状态、错误提示
- ✅ 数据可视化
- ✅ 深色模式

## 依赖清单 (requirements.txt)

```txt
# PyTorch生态 (统一深度学习框架)
torch>=2.0.0
torchvision>=0.15.0
facenet-pytorch>=2.5.2

# YOLO
ultralytics>=8.0.0

# 传统机器学习
scikit-learn>=1.3.0
numpy>=1.24.0
pandas>=2.0.0

# 图像处理
opencv-python>=4.8.0
Pillow>=10.0.0
mediapipe>=0.10.0

# Web框架
Flask>=2.3.0
Flask-CORS>=4.0.0
flask-sqlalchemy>=3.0.0

# 数据库
SQLAlchemy>=2.0.0

# 可选: DeepFace (可配置使用PyTorch后端)
deepface>=0.0.79

# 工具
python-dotenv>=1.0.0
```

## 配置文件示例

### backend/config/settings.py
```python
import os
from pathlib import Path

BASE_DIR = Path(__file__).resolve().parent.parent

class Config:
    # 路径配置
    MODEL_DIR = BASE_DIR / 'saved_models'
    DATA_DIR = BASE_DIR / 'data'
    LOG_DIR = BASE_DIR / 'logs'
    USER_FACES_DIR = DATA_DIR / 'user_faces'
    
    # 模型文件
    YOLO_MODEL = MODEL_DIR / 'yolov8n-face.pt'
    FACENET_EMBEDDINGS = MODEL_DIR / 'facenet_embeddings.npz'
    FACENET_SVM = MODEL_DIR / 'facenet_svm.pkl'
    EMOTION_CNN = MODEL_DIR / 'emotion_cnn.pth'
    EMOTION_SVM = MODEL_DIR / 'emotion_svm.pkl'
    
    # 数据库
    DATABASE_URI = f'sqlite:///{DATA_DIR / "database.db"}'
    
    # 模型参数
    YOLO_THRESHOLD = 0.5
    FACE_SIZE = (160, 160)
    EMOTION_CLASSES = ['happy', 'sad', 'surprised']
    DEFAULT_EMOTION_MODEL = 'pytorch'  # 'pytorch', 'sklearn', 'deepface'
    
    # API配置
    API_HOST = '0.0.0.0'
    API_PORT = 8088
    CORS_ORIGINS = ['http://localhost:3000', 'http://localhost:5173']
    
    # 日志
    LOG_LEVEL = 'INFO'
    
    # GPU
    USE_CUDA = True
```

## 后续扩展

1. **JWT认证**: 添加用户登录认证
2. **WebSocket**: 实时打卡广播
3. **Docker**: 容器化部署
4. **监控**: Prometheus + Grafana
5. **单元测试**: pytest覆盖核心逻辑
6. **API文档**: Swagger/OpenAPI
7. **多摄像头**: 支持多设备接入
8. **人脸活体检测**: 防止照片欺骗

## 时间估算

- **训练模块重构**: 2-3天
- **后端核心开发**: 3-4天
- **前端开发**: 3-4天
- **测试与优化**: 2天
- **总计**: 10-13天

---

**开始日期**: 2025年11月17日
**优先级**: 训练模块 → 后端 → 前端
**原则**: 统一PyTorch,统一YOLO,模块化设计
