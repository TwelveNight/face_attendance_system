# 权限控制系统实现文档

## 📋 实现概述

根据业务需求，实现了基于角色的权限控制系统，区分**管理员**、**普通用户**和**访客**三种角色。

---

## 🎯 角色定义

### 1. 访客（未登录）
**可访问功能**:
- ✅ 考勤打卡（人脸识别）

**菜单显示**:
- 考勤打卡

**限制**:
- ❌ 不能查看任何统计数据
- ❌ 不能管理用户
- ❌ 不能查看历史记录

### 2. 普通用户（已登录）
**可访问功能**:
- ✅ 考勤打卡
- ✅ 查看个人考勤记录
- ✅ 个人中心（修改密码等）
- ✅ 申请请假/补卡（后续功能）

**菜单显示**:
- 考勤打卡
- 我的考勤
- 个人中心

**限制**:
- ❌ 不能查看其他用户数据
- ❌ 不能管理用户
- ❌ 不能查看全局统计

### 3. 管理员（已登录）
**可访问功能**:
- ✅ 所有功能
- ✅ 仪表盘
- ✅ 用户管理
- ✅ 考勤历史（所有人）
- ✅ 统计分析
- ✅ 系统配置

**菜单显示**:
- 仪表盘
- 考勤打卡
- 用户管理
- 考勤历史
- 统计分析

**特权**:
- 👑 用户名前显示皇冠图标
- 可以录入/删除用户
- 可以查看所有数据

---

## 🔐 登录流程

### 管理员登录
1. 访问 `/admin/login`
2. 输入用户名和密码
3. 登录成功后跳转到仪表盘
4. 右上角显示 "👑 系统管理员"

### 普通用户登录
1. 访问 `/login`
2. 输入用户名或学号和密码
3. 登录成功后跳转到考勤打卡页面
4. 右上角显示用户名

### 首次设置密码
1. 访问 `/set-password`
2. 输入用户名验证身份
3. 设置新密码
4. 跳转到登录页面

---

## 📂 新增文件

### 前端组件
```
frontend/src/
├── components/
│   └── PrivateRoute.tsx              # 路由守卫组件
├── pages/
│   ├── UserLogin/
│   │   ├── index.tsx                 # 普通用户登录页面
│   │   └── style.css
│   └── SetPassword/
│       ├── index.tsx                 # 首次设置密码页面
│       └── style.css
```

### 修改的文件
```
frontend/src/
├── App.tsx                           # 添加路由守卫和新路由
└── components/Layout/MainLayout.tsx  # 根据权限显示菜单
```

---

## 🛡️ 路由守卫

### AdminRoute
保护仅管理员可访问的路由。

**使用示例**:
```tsx
<Route path="dashboard" element={<AdminRoute><Dashboard /></AdminRoute>} />
```

**逻辑**:
- 检查 `isAuthenticated` 和 `userType === 'admin'`
- 未通过验证则跳转到 `/admin/login`

### UserRoute
保护需要登录的路由（管理员或普通用户）。

**使用示例**:
```tsx
<Route path="profile" element={<UserRoute><Profile /></UserRoute>} />
```

**逻辑**:
- 检查 `isAuthenticated`
- 未登录则跳转到 `/login`

### PublicRoute
公开路由，任何人都可以访问。

**使用示例**:
```tsx
<Route path="attendance" element={<Attendance />} />
```

---

## 🎨 UI变化

### 未登录状态
**Header右上角**:
```
[用户登录] [管理员登录]
```

**侧边栏菜单**:
- 考勤打卡

### 普通用户登录
**Header右上角**:
```
张三 ▼
├─ 个人信息
└─ 登出
```

**侧边栏菜单**:
- 考勤打卡
- 我的考勤
- 个人中心

### 管理员登录
**Header右上角**:
```
👑 系统管理员 ▼
├─ 个人信息
└─ 登出
```

**侧边栏菜单**:
- 仪表盘
- 考勤打卡
- 用户管理
- 考勤历史
- 统计分析

---

## 🔄 路由配置

### 公开路由
| 路径 | 页面 | 说明 |
|------|------|------|
| `/admin/login` | 管理员登录 | 独立页面 |
| `/login` | 用户登录 | 独立页面 |
| `/set-password` | 设置密码 | 独立页面 |
| `/attendance` | 考勤打卡 | 主布局内 |

### 管理员路由
| 路径 | 页面 | 说明 |
|------|------|------|
| `/dashboard` | 仪表盘 | 需要管理员权限 |
| `/users` | 用户管理 | 需要管理员权限 |
| `/history` | 考勤历史 | 需要管理员权限 |
| `/statistics` | 统计分析 | 需要管理员权限 |

### 用户路由（后续添加）
| 路径 | 页面 | 说明 |
|------|------|------|
| `/my-attendance` | 我的考勤 | 需要登录 |
| `/profile` | 个人中心 | 需要登录 |
| `/leave-request` | 请假申请 | 需要登录 |

---

## 🧪 测试场景

### 场景1：未登录访问管理员页面
1. 未登录状态
2. 访问 `/dashboard`
3. **预期**: 自动跳转到 `/admin/login`

### 场景2：普通用户访问管理员页面
1. 普通用户登录
2. 尝试访问 `/users`
3. **预期**: 自动跳转到 `/admin/login`

### 场景3：管理员访问所有页面
1. 管理员登录
2. 访问任意页面
3. **预期**: 正常访问

### 场景4：未登录打卡
1. 未登录状态
2. 访问 `/attendance`
3. **预期**: 可以正常打卡（人脸识别）

### 场景5：菜单显示
1. 未登录：只显示"考勤打卡"
2. 普通用户：显示"考勤打卡"、"我的考勤"、"个人中心"
3. 管理员：显示所有菜单

---

## 💡 业务逻辑说明

### 为什么没有用户注册功能？

**原因**:
1. ✅ 企业/学校内部系统，用户由管理员统一管理
2. ✅ 避免恶意注册
3. ✅ 确保用户信息准确性
4. ✅ 便于人脸数据管理

**流程**:
1. 管理员在"用户管理"中录入用户（姓名、学号、人脸照片）
2. 用户首次使用时访问 `/set-password` 设置密码
3. 之后可以正常登录查看个人数据

### 为什么打卡不需要登录？

**原因**:
1. ✅ 提高打卡效率（人脸识别即可）
2. ✅ 避免忘记密码导致无法打卡
3. ✅ 人脸识别已经确认身份

**安全性**:
- 人脸识别本身就是身份验证
- 打卡记录有时间戳和照片存档
- 管理员可以查看所有打卡记录

---

## 🔧 技术实现

### 1. 状态管理
使用 Zustand 管理认证状态:
```typescript
{
  token: string | null;
  userType: 'admin' | 'user' | null;
  currentUser: any | null;
  isAuthenticated: boolean;
}
```

### 2. 路由守卫
使用高阶组件包装需要保护的路由:
```tsx
<Route path="dashboard" element={<AdminRoute><Dashboard /></AdminRoute>} />
```

### 3. 动态菜单
根据 `userType` 动态生成菜单项:
```typescript
const getMenuItems = () => {
  if (!isAuthenticated) return [/* 公开菜单 */];
  if (userType === 'admin') return [/* 管理员菜单 */];
  return [/* 用户菜单 */];
};
```

### 4. Token管理
- 自动添加到所有API请求头
- 持久化存储到 localStorage
- 过期自动跳转登录页

---

## 📊 权限矩阵

| 功能 | 访客 | 普通用户 | 管理员 |
|------|------|----------|--------|
| 人脸打卡 | ✅ | ✅ | ✅ |
| 查看个人考勤 | ❌ | ✅ | ✅ |
| 查看所有考勤 | ❌ | ❌ | ✅ |
| 用户管理 | ❌ | ❌ | ✅ |
| 统计分析 | ❌ | ❌ | ✅ |
| 仪表盘 | ❌ | ❌ | ✅ |
| 修改密码 | ❌ | ✅ | ✅ |
| 请假申请 | ❌ | ✅ | ✅ |
| 审批请假 | ❌ | ❌ | ✅ |

---

## 🚀 使用指南

### 管理员首次使用
1. 访问 `http://localhost:5173/admin/login`
2. 输入: `admin` / `admin123`
3. 登录后可以管理所有功能

### 普通用户首次使用
1. 管理员先在"用户管理"中录入用户信息
2. 用户访问 `http://localhost:5173/set-password`
3. 输入用户名验证身份
4. 设置密码
5. 访问 `http://localhost:5173/login` 登录

### 访客打卡
1. 直接访问 `http://localhost:5173/attendance`
2. 进行人脸识别打卡
3. 无需登录

---

## 📝 后续优化

### 待实现功能
- [ ] 我的考勤页面
- [ ] 个人中心页面
- [ ] 请假申请功能
- [ ] 补卡申请功能
- [ ] 密码找回功能
- [ ] 记住登录状态（7天）

### 安全增强
- [ ] 登录失败次数限制
- [ ] 验证码功能
- [ ] 密码强度检查
- [ ] 操作日志记录
- [ ] Token自动刷新

---

**实现日期**: 2025-11-19
**版本**: v2.1
**状态**: ✅ 已完成并测试
